## 21.Dockerfile

### 21.1 语法

| 指令        | 含义                                                                                      | 示例                                                                           |
| ----------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| FROM        | 构建的新镜像是基于那个镜像                                                                | FROM centos:6                                                                  |
| MAINTAINER  | 镜像维护者姓名或邮箱地址                                                                  | MAINTAINER zhufengjiagou                                                       |
| FUN         | 构建镜像是运行的 shell 命令                                                               | RUN yun install httpd                                                          |
| CMD         | CMD 设置容器启动后默认执行的命令及其参数，但 CMD 能够被 docker run 后面跟的命令行参数替换 | CMD/usr/sbin/sshd -D                                                           |
| EXPOSE      | 声明容器运行的服务器端口                                                                  | EXPOSE 80 443                                                                  |
| ENV         | 设置容器内的环境变量                                                                      | ENV MYSQL_ROOT_PASSWORD 123456                                                 |
| ADD         | 拷贝文件或目录到镜像中，如果是 URL 或者压缩包会自动下载和解压                             | ADD,ADD https://xxx.com/html.tar.gz /var/www.html,ADD html.tar.gz/var/www/html |
| COPY        | 拷贝文件或目录到镜像                                                                      | COPY ./start/start.sh                                                          |
| ENTAYPOINT  | 配置容器启动时运行的命令                                                                  | ENTRYPOINT /bin/bash -c'/start.sh'                                             |
| VOLUME      | 为 RUN CMD ENTRYPOINT COPY ADD 设置工作目录                                               | USER zhufengjiagou                                                             |
| HEALTHCHECK | 健康检查                                                                                  | HEALTHCHECK --interval=5m --timeout=3s --retries=3 CMS curl -f htp://localhost |
| ARG         | 在构建镜像时指定一些参数                                                                  | ARG user                                                                       |

### 21.2 build 镜像命令

* -t --tag list 镜像名称
* -f --file string 指定 Dockerfile 文件的位置

### 21.3 搭建 nginx 镜像

```
mkdir /usr/local/src
cd /usr/local/src
wget http://nginx.org/download/nginx-1.12.1.tar.gz
#如果容器内无法联网可以重启docker
systemctl restart docker
```

```
FROM centos
MAINTAINER zhufengjiagou
RUN yum isntall -y gcc gcc-c++ make openssl-devel pcre-devel
ADD nginx-1.12.1.tar.gz /tmp
RUN cd /tmp/nginx-1.12.1 && \
./configure --prefix=/usr/local/nginx && \
make -j 2 &&\
make innstall
RUN rm -rf /tmp/nginx-1.12.1 && yum clean all
COPY nginx.conf /usr/local/nginx/conf
EXPOSE 80
CMD ['./sbin/nginx','-g','daemon off:']
```

### 21.4 搭建 php 镜像

```
wget http://nchc.dl.sourceforge.net/project/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.gz
wget http://cn.php.net/distributions/php-5.6.30.tar.gz
```

```
FROM centos
MAINTAINER zhufengjiagou
RUN yum -y install gcc gcc-c++ make automake autoconf libtool openssl-devel pcre-devel libxml2 libxml2-devel bzip2 bzip2-devel libjpeg-turbo libjpeg-turbo-devellibpng libpng-devel freetype freetype-devel zlib zlib-devel libcurl libcurl-devel
ADD libmcrypt-2.5.8.tar.gz /tmp
RUN cd /tmp/libmcrypt-2.5.8 && \
./configure && \
make -j 2 && \
make install
ADD php-5.6.30.tar.gz /tmp
RUN cd /tmp/php-5.6.30 && \
./configure --prefix=/usr /local/php --with-pdo-mysql=mysqlnd --with-mysqli=mysqlnd --with-mysql=mysqlnd --with-openssl -enable-mbstring --with-libxml-dir=/usr --enable-xml enable-sockets --enable-fpm --with-config-file-path=/usr/local/php/etc --wtth-bz2 --with-gd && \
make -j 2 && \
make install
RUN cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf
RUN sed -i 's/127.0.0.1/0.0.0.0/g' /usr/local/php/etc/php-fpm.conf
RUN rm -rf /tmp/php-5.6.30 && yum clean all
WORKDIR /usr/local/php
WXPOSE 9000
CMD ["/usr/local/php/sbin/php-fpm","-c","/usr/local/php/etc/php-fpm.conf"]
```

```
docker image build -t php -t php:v1 -f Dockerfile .
```
