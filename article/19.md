## 19.nodeapp

nodeapp 是一个用 Docker 搭建的本地 Node.js 应用开发与运行环境。

### 19.1 服务

* db：使用`mariadb`作为应用的数据库。
* node:启动`node`服务
* web：使用`nginx`作为应用的 web 服务器

### 19.2 结构

* app：这个目录存储应用
* web 放应用的代码
* services:环境里定义的服务需要的一些服务
* images:方式一些贬义的脚本和镜像
* docker-compose.yml:定义本地开发环境需要的服务
* images/nginx/config/default.conf 放置 nginx 配置文件
* node 的 Docker 配置文件

### 19.3 docker-compose.yml

```
version:'2'
services:
    node:
     build:
       context:./images/node
       dockerfile:Dockerfile
     volumes:
        - ./app/web:/web
     depends_on:
        - db
    web:
     image:nginx
     ports:
        - "8080:80"
     volumes:
        - ./images/nginx/config:/etc/nginx/conf.d
        - ./app/web/views:/mnt/views
     depends_on:
        - node
    db:
     image:mariadb
     environment:
      MYSQL_ROOT_PASSWORD:'root'
      MYSQL_DATABASE:'node'
      MYSQL_USER:'zfpx'
      MYSQL_PASSWORD:'123456'
    volumes:
     db:
      driver:local
```

### 19.4 其他文件

#### 19.41 app/web/server.js

```
let http=require('http')
var mysql=require("mysql")
var connection=mysql.createConnection({
    host:'db',
    user:'zfpx',
    password:'123456',
    database;:'node'
})
connection.connect()
let server=http.createServer(function(req,res){
    connection.query('SELECT 2 + 2 AS solution',function(error,results,fields){
        if(error)throw error;
        res.end(''+results[0].solution)
    })
})
server.listen(3000)
```

#### 19.4.2 package.json

```
"scripts":{
    "start":"node server.js"
},
"dependencies":{
    "mysql":"^2.16.0"
}
```

#### 19.4.3 images/node/Dockerfile

```
FROM node
MAINTAINER zhangrenyang <zhang_renyang@126.com>
WORKDIR /web
RUN npm install
CMD npm start
```

#### 19.4.4 images/nginx/config/default.conf

```
upstream backend{
    server node:3000;
}
server{
    listen 80;
    server_name localhost;
    root /mnt/views;
    index index.html index.html

    localhost /api {
        proxy_pass http://backend;
    }
}
```
