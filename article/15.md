## 15.制作 Dockerfile

* Docker 的镜像使用一层一层的文件组成的
* `docker inspect`命令可以查看镜像或者容器
* Layers 就是镜像层文件，只读不能修改。基于镜像创建的容器会共享这些文件层。

```
docker inspect centos
```

### 15.1 编写 Dockerfile

| 命令    | 含义                 | 案例              |
| ------- | -------------------- | ----------------- |
| FROM    | 继承的镜像           | FROM node         |
| COPY    | 拷贝                 | COPY /.app /app   |
| WORKDIR | 指定工作路径         | WORKDIR/app       |
| RUN     | 编译打包阶段运行命令 | RUN npm install   |
| EXPOSE  | 暴露端口             | EXPOSE 3000       |
| CMD     | 容器运行阶段运行命令 | CMD npm run start |

### 15.2.dockerignore

表示要排除，不要打包到 image 中的文件路径

```
.git
node_modules
```

### 15.3Dockerfile

#### 15.3.1 安装 node

* nvm

```
wget -q0- https://raw.githubusrecontent.com/createionix/nvm/v0.33.11/install.sh|bash
nvm install stable
node -v
npm i cnpm -g
npm i rnm -g
```

#### 15.3.2 安装 express 项目生成器

```
npm install express-generator -g
express app
```

### 15.3.3Dockerfile

```
FROM node
COPY ./app /app
WORKDIR /app
RUN npm install
EXPOSE 3000
```

* FROM 表示该镜像继承的镜像：表示标签
* COPY 是将当前目录下的 app 目录下面的文件都拷贝到 image 里的/app 目录中
* WORKDIR 指定工作路径，类似于执行`cd` 命令
* RUN npm install 在/app 目录下安装依赖，安装后的依赖也会打包到 image 目录中
* EXPOSE 暴露 3000 端口，允许外部连接这个端口

### 15.4 创建 image

```
docker build -t express-demo .
```

* -t 用来指定 image 镜像的名称，后面还可以加冒号指定标签，如果不指定默认就是 latest
* `.`表示 Dockerfile 文件的所有路径，`.`就表示当前路径

### 15.5 使用新的镜像运行容器

```
docker container run -p 3333:3000 -it express-demo /bin/bash
```

```
npm start
```

* `-p`参数是将容器 3000 端口映射为本机 3333 端口
* -it 参数是将容器的 shell 容器映射为当前 shell，在本机容器中执行的命名都会发送到容器当中执行
* `express-demo`image 名称
* /bin/bash 容器启动后执行的第一个命令，这里是启动了 bash 容器以便执行脚本
* `--rm`在容器终止运行后自动删除容器文件

### 15.6CMD

```
CMD npm start
```

* RUN 命令在 image 文件的构建阶段执行，执行结果都会打包进入 image 文件；CMD 命令则是在容器启动后执行。
* 一个 Dockerfile 可以包含多个 RUN 命令，但是只能有一个 CMD 命令
* 指定了 CMD 命令以后，docker container run 命令就不能附加命令了（比如前面/bin/bash）,否则它会覆盖 CMD 命令

### 15.7image

* 注册账户
* docker tag SOURCE_IMAGE[:TAG]TARGET_IMAGE[:TAG]

```
docker login
docker image tag [imageName] [username]/[repository]:[tag]
docker image build -t [username]/[repository]:[tag] .

docker tag express-demo zhangrenyang/express-demo:1.0.0
docker push zhangrenyang/express-demo:1.0.0
```
